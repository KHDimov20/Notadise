@{
    ViewData["Title"] = "New Note";
}

<div class="new-note-container">
    <!-- Header -->
    <div class="note-header">
        <input type="text" id="noteHeader" placeholder="HEADER" class="note-header-input" />
    </div>

    <!-- Custom Category Dropdown -->
    <div class="note-category">
        <label for="noteCategory">Category:</label>
        <div class="custom-select">
            <select id="noteCategory" class="note-category-select">
                <!-- Default categories will be populated dynamically -->
            </select>
        </div>
        <br />
        <br />
       
        <!-- Button to add a new category -->
        <button id="addCategoryBtn" class="add-category-btn">+ Add Category</button>
    </div>
    <br />

    <!-- Input field to add new category (hidden initially) -->
    <div class="new-category-input" style="display: none;">
        <input type="text" id="newCategoryName" class="new-category-name" placeholder="Enter new category name" />
        <button id="saveNewCategoryBtn" class="save-new-category-btn">Save</button>
    </div>
    <br />
    <br />

    <!-- Note Sections -->
    <div class="note-sections" id="noteSections"></div>

    <!-- Add Section Button -->
    <button id="addSectionBtn" class="add-section-btn">+</button>

    <!-- Save Button -->
    <button id="saveNoteBtn" class="save-note-btn">Save</button>

    <div id="savePrompt" class="modal">
    <div class="modal-content">
        <h3>Success!</h3>
        <p>Your note has been saved successfully.</p>
        <button id="closeSavePrompt" class="close-btn">Close</button>
    </div>
</div>


</div>

@section Scripts {
    <script>
        let sectionCount = 0;

        // Default categories
        const defaultCategories = ["School", "University", "Work", "Art Projects"];

        // Load the page
        document.addEventListener('DOMContentLoaded', () => {
            const savedNotes = JSON.parse(localStorage.getItem('savedNotes')) || [];
            const editNoteIndex = localStorage.getItem('editNoteIndex'); // Get the index of the note to edit

            if (editNoteIndex !== null) {
                const noteToEdit = savedNotes[editNoteIndex];

                if (noteToEdit) {
                    // Populate the editor fields with the note's data
                    document.getElementById('noteHeader').value = noteToEdit.header;

                    const sectionsContainer = document.getElementById('sectionsContainer');
                    sectionsContainer.innerHTML = ''; // Clear any existing sections

                    noteToEdit.sections.forEach(section => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.classList.add('section');

                        sectionDiv.innerHTML = `
                            <textarea class="section-text">${section.text}</textarea>
                            <button class="remove-section-btn">Remove</button>
                        `;

                        sectionsContainer.appendChild(sectionDiv);
                    });
                } else {
                    console.warn('No note found for the provided index.');
                }
            }

            // Optional: Clear the edit index from localStorage if you want the editor to reset on a new note creation
            localStorage.removeItem('editNoteIndex');
        });

        // Save note function
        document.getElementById('saveNoteBtn').addEventListener('click', () => {
            const savedNotes = JSON.parse(localStorage.getItem('savedNotes')) || [];
            const editNoteIndex = localStorage.getItem('editNoteIndex'); // Check if editing an existing note

            const updatedNote = {
                header: document.getElementById('noteHeader').value,
                sections: Array.from(document.querySelectorAll('.section-text')).map(section => ({
                    text: section.value
                }))
            };

            if (editNoteIndex !== null) {
                // Update the existing note
                savedNotes[editNoteIndex] = updatedNote;
            } else {
                // Add a new note
                savedNotes.push(updatedNote);
            }

            localStorage.setItem('savedNotes', JSON.stringify(savedNotes));

            // Remove any old prompt (e.g., alert()) and show the modal instead
            const savePrompt = document.getElementById('savePrompt');
            savePrompt.classList.add('show');

            // Redirect to MyNotes after 2 seconds (or when the user closes the modal)
            setTimeout(() => {
                savePrompt.classList.remove('show');
                window.location.href = "/Notes/MyNotes";
            }, 2000);
        });

        // Close Save Prompt
        document.getElementById('closeSavePrompt').addEventListener('click', () => {
            const savePrompt = document.getElementById('savePrompt');
            savePrompt.classList.remove('show');
            window.location.href = "/Notes/MyNotes"; // Redirect to MyNotes page
        });



        // Function to load categories from localStorage and populate the dropdown
        function loadCategories() {
            const savedCategories = JSON.parse(localStorage.getItem('categories')) || [];
            const categoryDropdown = document.getElementById('noteCategory');
            categoryDropdown.innerHTML = ''; // Clear previous options

            if (savedCategories.length === 0) {
                const noCategoryOption = document.createElement('option');
                noCategoryOption.textContent = 'No categories available';
                noCategoryOption.disabled = true;
                categoryDropdown.appendChild(noCategoryOption);
            } else {
                savedCategories.forEach(category => {
                    const categoryOption = document.createElement('option');
                    categoryOption.textContent = category;
                    categoryOption.value = category;
                    categoryDropdown.appendChild(categoryOption);
                });
            }
        }

        // Event listener for "+ Add Category" button
        document.getElementById('addCategoryBtn').addEventListener('click', () => {
            const newCategoryInput = document.querySelector('.new-category-input');
            newCategoryInput.style.display = 'block'; // Show the input field
        });

        // Event listener for "Save" button inside the new category input
        document.getElementById('saveNewCategoryBtn').addEventListener('click', () => {
            const categoryInput = document.getElementById('newCategoryName');
            const newCategory = categoryInput.value.trim();

            if (newCategory === '') {
                alert('Category cannot be empty!');
                return;
            }

            const savedCategories = JSON.parse(localStorage.getItem('categories')) || [];
            if (savedCategories.includes(newCategory)) {
                alert('Category already exists!');
                return;
            }

            // Add the new category to localStorage
            savedCategories.push(newCategory);
            localStorage.setItem('categories', JSON.stringify(savedCategories));

            // Reset input and reload categories
            categoryInput.value = '';
            document.querySelector('.new-category-input').style.display = 'none'; // Hide the input field
            loadCategories(); // Reload categories in the dropdown
        });

        // Load categories when the page is loaded
        window.addEventListener('DOMContentLoaded', loadCategories);



        // Populate the categories dropdown
        function populateCategoriesDropdown(categories) {
            const categorySelect = document.getElementById("noteCategory");
            categorySelect.innerHTML = ""; // Clear existing options
            categories.forEach((category) => {
                if (typeof category === "string") {
                    const option = document.createElement("option");
                    option.value = category.toLowerCase().replace(/\s+/g, "-"); // Convert to a valid value
                    option.textContent = category;
                    categorySelect.appendChild(option);
                } else {
                    console.warn("Skipping invalid category:", category);
                }
            });
        }


        // Save the final note to localStorage
        document.getElementById('saveNoteBtn').addEventListener('click', () => {
            const savedNotes = JSON.parse(localStorage.getItem('savedNotes')) || [];
            const editNoteIndex = localStorage.getItem('editNoteIndex'); // Check if editing an existing note

            const updatedNote = {
                header: document.getElementById('noteHeader').value,
                sections: Array.from(document.querySelectorAll('.section-text')).map(section => ({
                    text: section.value
                }))
            };

            if (editNoteIndex !== null) {
                // Update the existing note
                savedNotes[editNoteIndex] = updatedNote;
            } else {
                // Add a new note
                savedNotes.push(updatedNote);
            }

            localStorage.setItem('savedNotes', JSON.stringify(savedNotes));

            // Show the save confirmation modal
            const savePrompt = document.getElementById('savePrompt');
            savePrompt.classList.add('show');

            // Redirect to MyNotes after 2 seconds (or when the user closes the modal)
            setTimeout(() => {
                savePrompt.classList.remove('show');
                window.location.href = "/Notes/MyNotes";
            }, 2000);
        });

        // Close Save Prompt
        document.getElementById('closeSavePrompt').addEventListener('click', () => {
            const savePrompt = document.getElementById('savePrompt');
            savePrompt.classList.remove('show');
            window.location.href = "/Notes/MyNotes"; // Redirect to MyNotes page
        });


        // Function to auto-save the note draft
        function setupAutoSave() {
            const noteHeader = document.getElementById("noteHeader");
            const noteCategory = document.getElementById("noteCategory");
            const noteSections = document.getElementById("noteSections");

            // Save header changes
            noteHeader.addEventListener("input", saveDraft);

            // Save category changes
            noteCategory.addEventListener("change", saveDraft);

            // Save section changes dynamically
            noteSections.addEventListener("input", saveDraft);
        }

        // Save the current note state as a draft in localStorage
        function saveDraft() {
            const noteData = collectNoteData();
            localStorage.setItem("noteDraft", JSON.stringify(noteData));
        }

        // Restore the saved note draft from localStorage
        function restoreNoteDraft(draft) {
            document.getElementById("noteHeader").value = draft.header || "";

            const noteCategory = document.getElementById("noteCategory");
            noteCategory.value = draft.category || "";

            // Restore sections
            const noteSections = document.getElementById("noteSections");
            noteSections.innerHTML = ""; // Clear existing sections
            draft.sections.forEach((section, index) => {
                const newSection = createSection(index + 1, section.title, section.text);
                noteSections.appendChild(newSection);
            });

            sectionCount = draft.sections.length;
        }

        // Collect the current note data from the form
        function collectNoteData() {
            const header = document.getElementById("noteHeader").value;
            const category = document.getElementById("noteCategory").value;
            const sections = [];

            // Collect all sections from the form
            document.querySelectorAll(".note-section").forEach((section) => {
                const title = section.querySelector(".section-title").value;
                const text = section.querySelector(".section-text").value;
                sections.push({ title, text });
            });

            return { header, category, sections };
        }

        // Populate the form when editing a note
        function populateNoteForEditing(noteToEdit) {
            document.getElementById("noteHeader").value = noteToEdit.header || "";

            const noteCategory = document.getElementById("noteCategory");
            noteCategory.value = noteToEdit.category || "";

            const noteSections = document.getElementById("noteSections");
            noteSections.innerHTML = ""; // Clear existing sections
            noteToEdit.sections.forEach((section, index) => {
                const newSection = createSection(index + 1, section.title, section.text);
                noteSections.appendChild(newSection);
            });

            sectionCount = noteToEdit.sections.length;
        }


        // Create a new section
        function createSection(number, title = "", text = "") {
            const sectionDiv = document.createElement("div");
            sectionDiv.classList.add("note-section");
            sectionDiv.id = `section${number}`;
            sectionDiv.innerHTML = `
                    <input type="text" class="section-title" placeholder="Point ${number}" value="${title}" />
                    <textarea class="section-text" placeholder="Write your text here...">${text}</textarea>
                `;
            return sectionDiv;
        }

        // Add a new section
        document.getElementById("addSectionBtn").addEventListener("click", function () {
            sectionCount++;
            const noteSections = document.getElementById("noteSections");
            const newSection = createSection(sectionCount);
            noteSections.appendChild(newSection);

            saveDraft(); // Auto-save after adding a new section
        });


        // Load categories from localStorage
        function loadCategoriesFromLocalStorage() {
            return JSON.parse(localStorage.getItem("categories")) || [];
        }

        // Save categories to localStorage
        function saveCategoriesToLocalStorage(categories) {
            localStorage.setItem("categories", JSON.stringify(categories));
        }

        
    </script>
}

<style>
    .custom-dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        background-color: #8A64AD;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .dropdown-menu {
        display: none;
        position: absolute;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        list-style-type: none;
        padding: 0;
        margin: 0;
        border-radius: 5px;
        z-index: 1000;
    }

    .dropdown-item {
        padding: 10px;
        color: white;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            opacity: 0.8;
        }

    .custom-dropdown:hover .dropdown-menu {
        display: block;
    }
    .new-note-container {
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .note-header-input {
        width: 100%;
        padding: 10px;
        font-size: 1.5rem;
        color: #8A64AD;
        border: none;
        border-bottom: 2px solid #8A64AD;
        outline: none;
        text-align: center;
    }

    .note-header-input::placeholder {
        color: #8A64AD;
        opacity: 0.6;
    }

    .note-category {
        margin-top: 20px;
    }

    /* Custom select styling */
    .custom-select {
        position: relative;
        display: inline-block;
        width: 100%;
        background-color: #f5f5f5;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .note-category-select {
        width: 100%;
        padding: 8px 15px;
        font-size: 1rem;
        border: none;
        border-radius: 5px;
        outline: none;
        background-color: #fff;
        color: #8A64AD;
        appearance: none; /* Removes default dropdown arrow */
        cursor: pointer;
    }

    /* Add custom arrow */
    .note-category-select::-ms-expand {
        display: none;
    }

    .note-category-select:focus {
        border-color: #8A64AD;
        box-shadow: 0 0 5px rgba(138, 100, 173, 0.5);
    }

    .note-category-select option {
        color: #333;
    }

    .add-category-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #8A64AD;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 5px;
    }

    .add-section-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 60px;
        height: 60px;
        background-color: #8A64AD;
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 65px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        position: fixed;
        bottom: 20px;
        right: 20px;
    }

    .add-section-btn:hover {
        transform: scale(1.1);
        background-color: #764DA9;
    }

    .add-section-btn:active {
        transform: scale(0.95);
    }

    .add-section-btn i {
        pointer-events: none;
    }

    .new-category-input {
        margin-top: 10px;
    }

    .new-category-name {
        width: 100%;
        padding: 8px;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
    }

    .save-new-category-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #8A64AD;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 5px;
    }

    .save-new-category-btn:hover {
        background-color: #764DA9;
    }

    .save-note-btn {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #8A64AD;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .save-note-btn:hover {
        background-color: #764DA9;
    }

    .modal {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

    .modal.show {
        display: flex; /* Show modal when the class "show" is added */
    }

    .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 80%;
        max-width: 400px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .modal-content h3 {
        margin-top: 0;
            color: #8A64AD; /* Green success color */
    }

    .modal-content p {
        margin: 10px 0;
        font-size: 16px;
    }

    .close-btn {
        background-color: #8A64AD;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        transition: background-color 0.3s;
    }

    .close-btn:hover {
            background-color: #8A64AD;
    }

</style>
