@{
    ViewData["Title"] = "New Note";
}

<div class="new-note-container">
    <!-- Header -->
    <div class="note-header">
        <input type="text" id="noteHeader" placeholder="HEADER" class="note-header-input" />
    </div>

    <!-- Custom Category Dropdown -->
    <div class="note-category">
        <label for="noteCategory">Category:</label>
        <div class="custom-select">
            <select id="noteCategory" class="note-category-select">
                <!-- Default categories will be populated dynamically -->
            </select>
        </div>
        <br />
        <br />
       
        <!-- Button to add a new category -->
        <button id="addCategoryBtn" class="add-category-btn">+ Add Category</button>
    </div>
    <br />

    <!-- Input field to add new category (hidden initially) -->
    <div class="new-category-input" style="display: none;">
        <input type="text" id="newCategoryName" class="new-category-name" placeholder="Enter new category name" />
        <button id="saveNewCategoryBtn" class="save-new-category-btn">Save</button>
    </div>
    <br />
    <br />

    <!-- Note Sections -->
    <div class="note-sections" id="noteSections"></div>

    <!-- Add Section Button -->
    <button id="addSectionBtn" class="add-section-btn">+</button>

    <!-- Save Button -->
    <button id="saveNoteBtn" class="save-note-btn">Save</button>
</div>

@section Scripts {
    <script>
        let sectionCount = 0;

        // Default categories
        const defaultCategories = ["School", "University", "Work", "Art Projects"];

        // Load the page
        window.addEventListener("DOMContentLoaded", function () {
            loadCategories(); // Load categories from localStorage or defaults

            // Retrieve the note data from localStorage
            const noteToEdit = JSON.parse(localStorage.getItem('editNote'));

            if (noteToEdit) {
                // Populate the note form with data from the noteToEdit object
                document.getElementById("noteHeader").value = noteToEdit.header || ''; // Set header

                // Set the category dropdown to the current note's category
                const categorySelect = document.getElementById("noteCategory");
                const noteCategory = noteToEdit.category || ''; // Get category from note data
                categorySelect.value = noteCategory.toLowerCase().replace(/\s+/g, "-"); // Normalize category name

                // Populate the sections dynamically
                sectionCount = noteToEdit.sections.length;
                const noteSections = document.getElementById("noteSections");
                noteToEdit.sections.forEach((section, index) => {
                    const newSection = createSection(index + 1, section.title, section.text);
                    noteSections.appendChild(newSection);
                });
            } else {
                // Clear draft data for a new note
                document.getElementById("noteHeader").value = ''; // Default blank header
                document.getElementById("noteCategory").value = defaultCategories[0].toLowerCase().replace(/\s+/g, "-"); // Default category
                sectionCount = 0;
            }
        });

        // Save final note to localStorage
        document.getElementById("saveNoteBtn").addEventListener("click", function () {
            const header = document.getElementById("noteHeader").value;
            const category = document.getElementById("noteCategory").value; // Get the selected category
            const sections = [];

            // Collect all sections from the form
            document.querySelectorAll(".note-section").forEach((section) => {
                const title = section.querySelector(".section-title").value;
                const text = section.querySelector(".section-text").value;
                sections.push({ title, text });
            });

            // Retrieve saved notes or initialize empty array
            const savedNotes = JSON.parse(localStorage.getItem("savedNotes")) || [];
            const editNoteIndex = localStorage.getItem("editNoteIndex");

            if (editNoteIndex) {
                // If editing, update the specific note
                savedNotes[editNoteIndex] = { header, category, sections }; // Include category here
                localStorage.removeItem("editNoteIndex"); // Clear the edit index after saving
            } else {
                // If creating a new note, add it to the list
                savedNotes.push({ header, category, sections }); // Include category here
            }

            // Save updated notes list
            localStorage.setItem("savedNotes", JSON.stringify(savedNotes));
            localStorage.removeItem("noteHeaderDraft");
            localStorage.removeItem("noteSectionsDraft");

            // Redirect to My Notes page
            window.location.href = "/Notes/MyNotes";
        });


        // Create a new section
        function createSection(number, title = "", text = "") {
            const sectionDiv = document.createElement("div");
            sectionDiv.classList.add("note-section");
            sectionDiv.id = `section${number}`;
            sectionDiv.innerHTML = `
                                                <input type="text" class="section-title" placeholder="Point ${number}" value="${title}" />
                                                <textarea class="section-text" placeholder="Write your text here...">${text}</textarea>
                                            `;
            return sectionDiv;
        }

        // Add a new section
        document.getElementById("addSectionBtn").addEventListener("click", function () {
            sectionCount++;
            const noteSections = document.getElementById("noteSections");
            const newSection = createSection(sectionCount);
            noteSections.appendChild(newSection);
        });

        // Show input field to add a new category
        document.getElementById("addCategoryBtn").addEventListener("click", function () {
            document.querySelector(".new-category-input").style.display = "block";
        });

        // Save the new category
        document.getElementById("saveNewCategoryBtn").addEventListener("click", function () {
            const newCategory = document.getElementById("newCategoryName").value.trim();

            if (newCategory) {
                const categories = loadCategoriesFromLocalStorage();
                if (!categories.includes(newCategory)) {
                    categories.push(newCategory); // Add new category
                    saveCategoriesToLocalStorage(categories); // Save updated categories
                    populateCategoriesDropdown(categories); // Refresh dropdown
                }
                document.getElementById("newCategoryName").value = ""; // Clear the input
                document.querySelector(".new-category-input").style.display = "none"; // Hide input field
            } else {
                alert("Please enter a valid category name.");
            }
        });

        // Load categories from localStorage or use defaults
        function loadCategories() {
            const categories = loadCategoriesFromLocalStorage();
            if (categories.length === 0) {
                saveCategoriesToLocalStorage(defaultCategories); // Save defaults if localStorage is empty
                populateCategoriesDropdown(defaultCategories);
            } else {
                populateCategoriesDropdown(categories);
            }
        }

        // Load categories from localStorage
        function loadCategoriesFromLocalStorage() {
            return JSON.parse(localStorage.getItem("categories")) || [];
        }

        // Save categories to localStorage
        function saveCategoriesToLocalStorage(categories) {
            localStorage.setItem("categories", JSON.stringify(categories));
        }

        // Populate the categories dropdown
        function populateCategoriesDropdown(categories) {
            const categorySelect = document.getElementById("noteCategory");
            categorySelect.innerHTML = ""; // Clear existing options
            categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category.toLowerCase().replace(/\s+/g, "-"); // Convert to a valid value
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
    </script>
}

<style>
    .custom-dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        background-color: #8A64AD;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .dropdown-menu {
        display: none;
        position: absolute;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        list-style-type: none;
        padding: 0;
        margin: 0;
        border-radius: 5px;
        z-index: 1000;
    }

    .dropdown-item {
        padding: 10px;
        color: white;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            opacity: 0.8;
        }

    .custom-dropdown:hover .dropdown-menu {
        display: block;
    }
    .new-note-container {
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .note-header-input {
        width: 100%;
        padding: 10px;
        font-size: 1.5rem;
        color: #8A64AD;
        border: none;
        border-bottom: 2px solid #8A64AD;
        outline: none;
        text-align: center;
    }

    .note-header-input::placeholder {
        color: #8A64AD;
        opacity: 0.6;
    }

    .note-category {
        margin-top: 20px;
    }

    /* Custom select styling */
    .custom-select {
        position: relative;
        display: inline-block;
        width: 100%;
        background-color: #f5f5f5;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .note-category-select {
        width: 100%;
        padding: 8px 15px;
        font-size: 1rem;
        border: none;
        border-radius: 5px;
        outline: none;
        background-color: #fff;
        color: #8A64AD;
        appearance: none; /* Removes default dropdown arrow */
        cursor: pointer;
    }

    /* Add custom arrow */
    .note-category-select::-ms-expand {
        display: none;
    }

    .note-category-select:focus {
        border-color: #8A64AD;
        box-shadow: 0 0 5px rgba(138, 100, 173, 0.5);
    }

    .note-category-select option {
        color: #333;
    }

    .add-category-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #8A64AD;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 5px;
    }

    .add-section-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 60px;
        height: 60px;
        background-color: #8A64AD;
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 65px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        position: fixed;
        bottom: 20px;
        right: 20px;
    }

    .add-section-btn:hover {
        transform: scale(1.1);
        background-color: #764DA9;
    }

    .add-section-btn:active {
        transform: scale(0.95);
    }

    .add-section-btn i {
        pointer-events: none;
    }

    .new-category-input {
        margin-top: 10px;
    }

    .new-category-name {
        width: 100%;
        padding: 8px;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
    }

    .save-new-category-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #8A64AD;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 5px;
    }

    .save-new-category-btn:hover {
        background-color: #764DA9;
    }

    .save-note-btn {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #8A64AD;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .save-note-btn:hover {
        background-color: #764DA9;
    }
</style>
