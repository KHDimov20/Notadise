@{
    ViewData["Title"] = "New Note";
}

<div class="new-note-container">
    <!-- Header -->
    <div class="note-header">
        <input type="text" id="noteHeader" placeholder="HEADER" class="note-header-input" />
    </div>

    <!-- Note Sections -->
    <div class="note-sections" id="noteSections"></div>

    <!-- Add Section Button -->
    <button id="addSectionBtn" class="add-section-btn">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Save Button -->
    <button id="saveNoteBtn" class="save-note-btn">Save</button>
</div>

@section Scripts {
    <script>
        let sectionCount = 0;

        // Load the page
        window.addEventListener('DOMContentLoaded', function () {
            const editNoteIndex = localStorage.getItem('editNoteIndex');

            if (editNoteIndex) {
                // If editing, load the selected note
                const savedNotes = JSON.parse(localStorage.getItem('savedNotes')) || [];
                const noteToEdit = savedNotes[editNoteIndex];

                if (noteToEdit) {
                    // Populate the note form with data
                    document.getElementById('noteHeader').value = noteToEdit.header;
                    sectionCount = noteToEdit.sections.length;
                    const noteSections = document.getElementById('noteSections');
                    noteToEdit.sections.forEach((section, index) => {
                        const newSection = createSection(index + 1, section.title, section.text);
                        noteSections.appendChild(newSection);
                    });
                }
            } else {
                // Clear draft data for a new note
                localStorage.removeItem('noteHeaderDraft');
                localStorage.removeItem('noteSectionsDraft');
            }
        });

        // Save final note to localStorage
        document.getElementById('saveNoteBtn').addEventListener('click', function () {
            const header = document.getElementById('noteHeader').value;
            const sections = [];

            document.querySelectorAll('.note-section').forEach(section => {
                const title = section.querySelector('.section-title').value;
                const text = section.querySelector('.section-text').value;
                sections.push({ title, text });
            });

            // Retrieve saved notes or initialize empty array
            const savedNotes = JSON.parse(localStorage.getItem('savedNotes')) || [];
            const editNoteIndex = localStorage.getItem('editNoteIndex');

            if (editNoteIndex) {
                // If editing, update the specific note
                savedNotes[editNoteIndex] = { header, sections };
                localStorage.removeItem('editNoteIndex'); // Clear the edit index after saving
            } else {
                // If creating a new note, add it to the list
                savedNotes.push({ header, sections });
            }

            // Save updated notes list
            localStorage.setItem('savedNotes', JSON.stringify(savedNotes));
            localStorage.removeItem('noteHeaderDraft');
            localStorage.removeItem('noteSectionsDraft');

            // Redirect to My Notes page
            window.location.href = "/Notes/MyNotes";
        });

        // Create a new section
        function createSection(number, title = '', text = '') {
            const sectionDiv = document.createElement('div');
            sectionDiv.classList.add('note-section');
            sectionDiv.id = `section${number}`;
            sectionDiv.innerHTML = `
                                <input type="text" class="section-title" placeholder="Point ${number}" value="${title}" />
                                <textarea class="section-text" placeholder="Write your text here...">${text}</textarea>
                            `;
            return sectionDiv;
        }

        // Add a new section
        document.getElementById('addSectionBtn').addEventListener('click', function () {
            sectionCount++;
            const noteSections = document.getElementById('noteSections');
            const newSection = createSection(sectionCount);
            noteSections.appendChild(newSection);
        });
    </script>
}

<style>
    /* Same styles as before */
    .new-note-container {
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .note-header-input {
        width: 100%;
        padding: 10px;
        font-size: 1.5rem;
        color: #8A64AD;
        border: none;
        border-bottom: 2px solid #8A64AD;
        outline: none;
        text-align: center;
    }

        .note-header-input::placeholder {
            color: #8A64AD;
            opacity: 0.6;
        }

    .note-sections {
        margin-top: 20px;
    }

    .note-section {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .section-title {
        width: 100%;
        padding: 8px;
        font-size: 1.2rem;
        margin-bottom: 10px;
        border: none;
        border-bottom: 2px solid #8A64AD;
        outline: none;
    }

    .section-text {
        width: 100%;
        padding: 8px;
        font-size: 1rem;
        height: 100px;
        resize: none;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
    }

    .add-section-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 50px;
        height: 50px;
        background-color: #8A64AD;
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        position: fixed;
        bottom: 20px;
        right: 20px;
    }

        .add-section-btn:hover {
            transform: scale(1.1);
        }

        .add-section-btn:active {
            transform: scale(0.95);
        }

        .add-section-btn i {
            pointer-events: none;
        }

    .save-note-btn {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #8A64AD;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

        .save-note-btn:hover {
            background-color: #764DA9;
        }
</style>
